<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NCK Study Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f4f6f8;
      --fg: #1a1a1a;
      --white: #ffffff;
      --primary: #1976d2;
      --hover: #004ba0;
      --warn: #ff4d4d;
      --warn-dark: #b71c1c;
      --light: #e0e0e0;
    }
    [data-theme="dark"] {
      --bg: #1e1e1e;
      --fg: #eeeeee;
      --white: #2c2c2c;
      --primary: #2196f3;
      --hover: #1565c0;
      --warn: #e53935;
      --warn-dark: #c62828;
      --light: #444;
    }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      padding: 2rem;
    }
    h1 {
      text-align: center;
    }
    .tabs, .controls {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 1rem;
      margin: 1rem 0;
    }
    .tab {
      padding: 0.7rem 1.5rem;
      background: var(--light);
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
    }
    .tab:hover, .active {
      background: var(--fg);
      color: var(--bg);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .unit {
      background: var(--white);
      padding: 1rem;
      border-radius: 10px;
      margin-bottom: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .unit-actions {
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .stars span {
      font-size: 1.2rem;
      cursor: pointer;
      color: #ccc;
    }
    .stars .selected {
      color: gold;
    }
    .comment-box {
      width: 100%;
      padding: 0.5rem;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .emergency {
      background: var(--warn);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .emergency.active {
      background: var(--warn-dark);
    }
    .summary, .chart, .theme-toggle {
      background: var(--white);
      padding: 1rem;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-top: 2rem;
    }
    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: var(--hover);
    }
    #timer {
      text-align: center;
      font-weight: bold;
      margin-bottom: 1rem;
    }
    canvas { max-width: 100%; }
  </style>
</head>
<body>
  <h1>NCK Study Progress Tracker</h1>
  <div id="timer">Time spent: 00:00:00</div>

  <div class="tabs">
    <button class="tab active" onclick="showTab(0)">Paper 1</button>
    <button class="tab" onclick="showTab(1)">Paper 2</button>
  </div>

  <div class="controls">
    <label><input type="checkbox" onchange="applyFilter('emergency')"> Show Emergency Only</label>
    <label><input type="checkbox" onchange="applyFilter('completed')"> Show Completed Only</label>
    <button onclick="toggleTheme()">Toggle Dark Mode</button>
    <button onclick="downloadNotes()">Download Comments</button>
  </div>

  <div id="tab0" class="tab-content active"></div>
  <div id="tab1" class="tab-content"></div>

  <div class="summary">
    <h2>Summary</h2>
    <p id="progressText"></p>
    <button onclick="exportPDF()">Export to PDF</button>
    <button onclick="resetTracker()">Reset Tracker</button>
    <button onclick="window.location.href='quiz.html'">Go to Quiz</button>
  </div>

  <div class="chart">
    <h3>Progress Chart</h3>
    <canvas id="progressChart"></canvas>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const paper1Units = ["Anatomy", "Basic Nursing", "Pharmacology", "Microbiology"];
    const paper2Units = ["Community Health", "PHC", "Growth & Development", "Immunization"];

    let filters = { emergency: false, completed: false };

    function createUnits(units, containerId) {
      const container = document.getElementById(containerId);
      units.forEach((unit, index) => {
        const id = `${containerId}_unit${index}`;
        const saved = JSON.parse(localStorage.getItem(id)) || {};

        const div = document.createElement('div');
        div.className = 'unit';
        div.setAttribute('data-id', id);
        div.innerHTML = `
          <label><input type="checkbox" ${saved.checked ? 'checked' : ''} onchange="saveState('${id}')"> ${unit}</label>
          <div class="unit-actions">
            <div class="stars">
              ${[1,2,3,4,5].map(i => `<span class="star ${saved.stars >= i ? 'selected' : ''}" onclick="rateStar(this, ${i}, '${id}')">â˜…</span>`).join('')}
            </div>
            <button class="emergency ${saved.flagged ? 'active' : ''}" onclick="toggleEmergency(this, '${id}')">Flag</button>
          </div>
          <textarea class="comment-box" placeholder="Comment..." oninput="saveState('${id}')">${saved.comment || ''}</textarea>
        `;
        container.appendChild(div);
      });
    }

    function rateStar(el, val, id) {
      const stars = el.parentNode.querySelectorAll('span');
      stars.forEach((s, i) => s.classList.toggle('selected', i < val));
      saveState(id);
    }

    function toggleEmergency(btn, id) {
      btn.classList.toggle('active');
      saveState(id);
    }

    function saveState(id) {
      const unit = document.querySelector(`[data-id='${id}']`);
      const checked = unit.querySelector('input[type=checkbox]').checked;
      const stars = unit.querySelectorAll('.star.selected').length;
      const flagged = unit.querySelector('.emergency').classList.contains('active');
      const comment = unit.querySelector('.comment-box').value;
      localStorage.setItem(id, JSON.stringify({ checked, stars, flagged, comment }));
      updateSummary();
      applyFilter();
    }

    function applyFilter() {
      document.querySelectorAll('.unit').forEach(unit => {
        const id = unit.getAttribute('data-id');
        const data = JSON.parse(localStorage.getItem(id)) || {};
        const matchesEmergency = !filters.emergency || data.flagged;
        const matchesCompleted = !filters.completed || data.checked;
        unit.style.display = (matchesEmergency && matchesCompleted) ? 'flex' : 'none';
      });
    }

    function applyFilter(type) {
      filters[type] = !filters[type];
      applyFilter();
    }

    function resetTracker() {
      if (confirm("Reset all progress?")) {
        localStorage.clear();
        location.reload();
      }
    }

    function exportPDF() {
      html2pdf().from(document.body).save('NCK_Progress.pdf');
    }

    function updateSummary() {
      const units = document.querySelectorAll('.unit');
      let covered = 0, total = units.length, flagged = 0, stars = 0, count = 0;
      units.forEach(unit => {
        const id = unit.getAttribute('data-id');
        const data = JSON.parse(localStorage.getItem(id)) || {};
        if (data.checked) covered++;
        if (data.flagged) flagged++;
        if (data.stars) { stars += data.stars; count++; }
      });
      const avg = count ? (stars / count).toFixed(1) : '0.0';
      const percent = ((covered / total) * 100).toFixed(1);
      document.getElementById('progressText').innerHTML =
        `Covered: ${covered}/${total} (${percent}%)<br>Avg Stars: ${avg}<br>Emergencies: ${flagged}`;
      updateChart(covered, total);
    }

    function updateChart(done, total) {
      const ctx = document.getElementById('progressChart').getContext('2d');
      if (window.chart) window.chart.destroy();
      window.chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Done', 'Remaining'],
          datasets: [{ data: [done, total - done], backgroundColor: ['#1976d2', '#ccc'] }]
        }
      });
    }

    function toggleTheme() {
      const body = document.body;
      const theme = body.getAttribute('data-theme') === 'dark' ? '' : 'dark';
      body.setAttribute('data-theme', theme);
    }

    function downloadNotes() {
      let data = {};
      document.querySelectorAll('.unit').forEach(unit => {
        const id = unit.getAttribute('data-id');
        const obj = JSON.parse(localStorage.getItem(id));
        if (obj?.comment?.trim()) data[id] = obj.comment;
      });
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'unit_comments.json';
      link.click();
    }

    let seconds = localStorage.getItem('studySeconds') || 0;
    setInterval(() => {
      seconds++;
      localStorage.setItem('studySeconds', seconds);
      const h = String(Math.floor(seconds / 3600)).padStart(2, '0');
      const m = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
      const s = String(seconds % 60).padStart(2, '0');
      document.getElementById('timer').textContent = `Time spent: ${h}:${m}:${s}`;
    }, 1000);

    createUnits(paper1Units, 'tab0');
    createUnits(paper2Units, 'tab1');
    updateSummary();
  </script>
</body>
</html>
